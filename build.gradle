def gitVersion = [ "git", "describe", "--match", "[0-9]*", "--dirty"].execute().text.trim()

task version {
	doLast {
		println "Version: ${gitVersion}"
	}
}

allprojects {
	group = 'com.prezi.spaghetti'
	version = gitVersion
	apply plugin: 'idea'
}

subprojects {
	apply plugin: 'groovy'
	apply plugin: 'maven'

	sourceCompatibility = "1.6"
	targetCompatibility = "1.6"

	repositories {
		mavenLocal()
		mavenCentral()
		maven {
			url "http://gradle.artifactoryonline.com/gradle/libs"
		}
	}

	dependencies {
		testCompile "junit:junit:4.11"
		testCompile "org.mockito:mockito-all:1.9.5"
		testCompile("org.spockframework:spock-core:0.7-groovy-1.8") {
			exclude group: "org.codehaus.groovy"
		}
	}

	uploadArchives {
		repositories {
			repositories {
				mavenDeployer {
					if (project.hasProperty("nexusUser") && project.hasProperty("nexusPassword")) {
						def user = project.getProperty("nexusUser")
						def password = project.getProperty("nexusPassword")
						repository(url: "https://artifactory.prezi.com/plugins-release-local/") {
							authentication(userName: user, password: password)
						}
						snapshotRepository(url: "https://artifactory.prezi.com/plugins-snapshot-local/") {
							authentication(userName: user, password: password)
						}
					}
				}
			}
		}
	}
}

configure(subprojects.findAll { it.name ==~ /spaghetti-.*-support/ }) {
	dependencies {
		compile project(path: ":spaghetti-core")
	}
}

project(":gradle-spaghetti-plugin") {
	dependencies {
		compile gradleApi()
		compile "com.google.javascript:closure-compiler:v20131014"
		compile project(path: ":spaghetti-core")
		// Add all support projects
		rootProject.subprojects.findAll { it.name ==~ /spaghetti-.*-support/ }.each { supportProject ->
			compile project(path: supportProject.path)
		}
	}

	task run(type: Exec) {
		workingDir "src/test/at"
		commandLine = ["gradle", "clean", "packApplication", "-is"]
	}
}
